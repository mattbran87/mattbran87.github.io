{%- comment -%}
  Render series table of contents with prev/next navigation.

  Usage:
    {% include series-toc.html %}

  Expects page.series (slug) and page.series_part (integer) in front matter.
  Series metadata (title, description) comes from _data/series.yml.
{%- endcomment -%}
{%- comment -%} Guard against missing series front matter {%- endcomment -%}
{%- if page.series and page.series_part -%}
    {%- comment -%} Look up series metadata from data file {%- endcomment -%}
    {%- assign series_meta = site.data.series[page.series] -%}
    {%- comment -%} Gather and sort all posts in this series by part number {%- endcomment -%}
    {%- assign series_posts = site.posts | where: "series", page.series | sort: "series_part" -%}
    {%- comment -%} Only render if there are series posts {%- endcomment -%}
    {%- if series_posts.size > 0 -%}
    <nav class="series-toc" aria-label="Series: {{ series_meta.title | default: page.series }}">
        <div class="series-toc__header">
            <span class="series-toc__label">Series</span>
            <h2 class="series-toc__title">
                <a href="{{ '/series/' | append: page.series | append: '/' | relative_url }}">
                    {{ series_meta.title | default: page.series }}
                </a>
            </h2>
            {%- comment -%} Show part count (e.g., "Part 2 of 3") {%- endcomment -%}
            <span class="series-toc__count">Part {{ page.series_part }} of {{ series_posts.size }}</span>
        </div>
        <ol class="series-toc__list">
            {%- comment -%} Render each part as a numbered list item {%- endcomment -%}
            {%- for series_post in series_posts -%}
                {%- comment -%} Highlight the current post with aria-current {%- endcomment -%}
                {%- if series_post.url == page.url -%}
            <li class="series-toc__item series-toc__item--current" aria-current="page">
                <span>{{ series_post.title | escape }}</span>
            </li>
                {%- else -%}
            <li class="series-toc__item">
                <a href="{{ series_post.url | relative_url }}">{{ series_post.title | escape }}</a>
            </li>
                {%- endif -%}
            {%- endfor -%}
        </ol>
        {%- comment -%} Prev/Next navigation within the series {%- endcomment -%}
        <div class="series-toc__nav">
            {%- comment -%} Find previous and next posts by part number {%- endcomment -%}
            {%- assign prev_part = page.series_part | minus: 1 -%}
            {%- assign next_part = page.series_part | plus: 1 -%}
            {%- assign prev_post = nil -%}
            {%- assign next_post = nil -%}
            {%- for series_post in series_posts -%}
                {%- if series_post.series_part == prev_part -%}
                    {%- assign prev_post = series_post -%}
                {%- endif -%}
                {%- if series_post.series_part == next_part -%}
                    {%- assign next_post = series_post -%}
                {%- endif -%}
            {%- endfor -%}
            {%- comment -%} Render prev link or empty spacer for flex alignment {%- endcomment -%}
            {%- if prev_post -%}
            <a class="series-toc__nav-link" href="{{ prev_post.url | relative_url }}" aria-label="Previous in series: {{ prev_post.title | escape }}">
                <span class="series-toc__nav-arrow" aria-hidden="true">&larr;</span> Previous
            </a>
            {%- else -%}
            <span></span>
            {%- endif -%}
            {%- comment -%} Render next link or empty spacer for flex alignment {%- endcomment -%}
            {%- if next_post -%}
            <a class="series-toc__nav-link" href="{{ next_post.url | relative_url }}" aria-label="Next in series: {{ next_post.title | escape }}">
                Next <span class="series-toc__nav-arrow" aria-hidden="true">&rarr;</span>
            </a>
            {%- else -%}
            <span></span>
            {%- endif -%}
        </div>
    </nav>
    {%- endif -%}
{%- endif -%}
